<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tienda de la Hoja ‚ö°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, writeBatch, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  </script>
  <style>
    body {
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
      touch-action: manipulation;
      overflow-x: hidden;
    }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes slideUpFade {
      0% { transform: translateY(20px); opacity: 0; }
      10% { transform: translateY(0); opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(10px); opacity: 0; }
    }
    .toast { animation: slideUpFade 2.5s ease-in-out forwards; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans h-screen overflow-hidden select-none">
  <div id="app" class="h-full flex flex-col"></div>

  <script type="module">
    // ================== CONFIGURACI√ìN ==================
    const firebaseConfig = {
      apiKey: "AIzaSyBCg7bn-XbNce5fuB9JrYPXVsw50li1ySA",
      authDomain: "tienda-hoja.firebaseapp.com",
      projectId: "tienda-hoja",
      storageBucket: "tienda-hoja.firebasestorage.app",
      messagingSenderId: "750612062192",
      appId: "1:750612062192:web:26a25fcb5013a03d494735"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const STORE_ID = 'sucursal-principal';

    // Habilitar persistencia con mejor manejo
    enableIndexedDbPersistence(db).catch(err => {
      console.warn("Persistencia offline desactivada:", err);
    });

    // ================== ESTADO ==================
    let user = null;
    let view = 'pos'; // 'pos' | 'corte'
    let admin = false;
    let search = '';
    let productos = [];
    let ventas = [];
    let carrito = [];
    let pago = '';
    let toasts = [];

    // ================== UTILIDADES ==================
    const notify = (text, type = 'success') => {
      const id = Date.now();
      toasts.push({ id, text, type });
      render();
      setTimeout(() => {
        toasts = toasts.filter(t => t.id !== id);
        render();
      }, 2500);
    };

    const formatCurrency = n => n.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // ================== RENDER ==================
    const render = () => {
      const total = carrito.reduce((a, b) => a + (b.price * b.quantity), 0);
      const filtered = productos.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));

      const appDiv = document.getElementById('app');
      appDiv.innerHTML = `
        <header class="bg-blue-900 text-white p-3 shadow-lg z-30 flex justify-between shrink-0">
          <div class="flex items-center gap-2">
            <div class="bg-orange-500 p-1.5 rounded-full border-2 border-white/20">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 9.5 17 9.5c0 .8-.5 2-1 2.5a6 6 0 0 1-3.5 1.5A5 5 0 0 0 12 19Z"></path><path d="M8 2.5A4 4 0 0 1 10.2 10c0 .5-.5 1-1 1a4 4 0 0 1-3.5-2A3.5 3.5 0 0 1 8 2.5Z"></path></svg>
            </div>
            <div><h1 class="font-bold text-lg">Tienda üçÅ</h1><p class="text-[10px] text-blue-200">En l√≠nea</p></div>
          </div>
          <div class="flex gap-2">
            <button id="btn-reload" class="p-2 bg-blue-800 rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
            </button>
            <button id="btn-admin" class="px-3 py-1.5 rounded-lg text-xs font-bold ${admin ? 'bg-orange-500' : 'bg-blue-800'}">${admin ? 'ADMIN' : 'VENTA'}</button>
            <button id="btn-toggle-view" class="p-2 bg-blue-800 rounded-lg">
              ${view === 'pos' ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4v16h16"/><path d="M8 4h8v16H8"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'}
            </button>
          </div>
        </header>

        <main class="flex-1 overflow-y-auto p-3 pb-48 relative">
          ${view === 'pos' ? renderPOS(filtered, admin) : renderCorte()}
        </main>

        ${view === 'pos' ? `
          <div class="bg-white border-t shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-30 shrink-0 pb-safe">
            <div id="cart-toggle" class="flex justify-between px-4 py-2 border-b cursor-pointer">
              <div class="flex gap-2 items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-900"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                <span class="font-bold text-sm text-gray-600">${carrito.length} √≠tems</span>
              </div>
              <span class="text-xl font-black text-blue-900">$${formatCurrency(total)}</span>
            </div>
            ${document.getElementById('cart-list') ? document.getElementById('cart-list').outerHTML : ''}
            <div class="p-3 flex gap-3">
              <div class="relative w-1/3">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4 2 2 0 1 0 0 4h6"/><path d="M16 16h1v4"/><path d="M16 8h1V4"/></svg>
                <input type="number" id="input-pago" placeholder="Pago" value="${pago}" class="w-full h-12 pl-8 pr-2 bg-gray-100 rounded-xl font-bold text-lg outline-none focus:ring-2 focus:ring-orange-500 text-center"/>
              </div>
              <button id="btn-checkout" class="flex-1 h-12 rounded-xl font-black text-lg shadow-lg ${carrito.length > 0 && (parseFloat(pago) || 0) >= total ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500'}">
                ${(parseFloat(pago) || 0) >= total && total > 0 ? `<span>COBRAR</span><span class="text-[10px] font-medium opacity-80">Cambio: $${formatCurrency(parseFloat(pago) - total)}</span>` : 'COBRAR'}
              </button>
            </div>
          </div>
        ` : ''}

        <div id="toasts" class="fixed bottom-24 left-0 right-0 flex flex-col items-center gap-2 pointer-events-none z-50 px-4">
          ${toasts.map(t => `
            <div class="toast bg-gray-900 text-white px-4 py-3 rounded-2xl shadow-xl flex items-center gap-3 text-sm font-bold backdrop-blur-md bg-opacity-90">
              ${t.type === 'success' ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><line x1="4" y1="4" x2="20" y2="20"/><line x1="20" y1="4" x2="4" y2="20"/></svg>'}
              ${t.text}
            </div>
          `).join('')}
        </div>
      `;

      // Eventos
      document.getElementById('btn-reload')?.addEventListener('click', () => window.location.reload());
      document.getElementById('btn-admin')?.addEventListener('click', () => { admin = !admin; render(); });
      document.getElementById('btn-toggle-view')?.addEventListener('click', () => { 
        view = view === 'pos' ? 'corte' : 'pos'; 
        render(); 
      });
      document.getElementById('input-pago')?.addEventListener('input', e => { 
        pago = e.target.value; 
        render(); 
      });
      document.getElementById('cart-toggle')?.addEventListener('click', () => {
        const list = document.getElementById('cart-list');
        if (list) list.remove();
        else if (carrito.length > 0) {
          const cartHtml = `
            <div id="cart-list" class="max-h-48 overflow-y-auto bg-gray-50 p-2">
              ${carrito.map(c => `
                <div class="flex justify-between items-center bg-white p-2 mb-1 rounded shadow-sm">
                  <span class="text-sm font-medium w-1/2 truncate">${c.name}</span>
                  <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-500">$${formatCurrency(c.price)} x ${c.quantity}</span>
                    <button class="text-red-400 remove-item" data-id="${c.id}">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          document.querySelector('.pb-safe')?.insertAdjacentHTML('afterend', cartHtml);
          document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', () => {
              carrito = carrito.filter(x => x.id !== btn.dataset.id);
              render();
            });
          });
        }
      });
      document.querySelectorAll('.product-item').forEach(el => {
        el.addEventListener('click', () => {
          if (!admin) {
            const id = el.dataset.id;
            const prod = productos.find(p => p.id === id);
            if (prod) {
              const ex = carrito.find(x => x.id === id);
              if (ex) ex.quantity++;
              else carrito.push({ ...prod, quantity: 1 });
              if (navigator.vibrate) navigator.vibrate(40);
              notify(`${prod.name} agregado`);
              render();
            }
          }
        });
      });
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const prod = productos.find(p => p.id === id);
          openProductModal(prod);
        });
      });
      document.getElementById('btn-checkout')?.addEventListener('click', checkout);
    };

    const renderPOS = (productos, admin) => {
      return `
        <div class="flex gap-2 items-start">
          <div class="flex-1">
            <div class="bg-white p-2 rounded-2xl shadow-sm mb-3 border border-gray-200 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 ml-2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
              <input id="search-input" value="${search}" class="w-full pl-3 pr-2 py-2 bg-transparent outline-none text-lg font-medium placeholder-gray-400" placeholder="Buscar..."/>
              ${search ? '<button id="btn-clear-search" class="p-2 text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>' : ''}
            </div>
          </div>
          ${admin ? '<button id="btn-new-product" class="bg-blue-600 text-white p-3 rounded-xl shadow h-[54px] w-[54px] flex justify-center items-center shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>' : ''}
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
          ${productos.map(p => {
            const n = carrito.find(x => x.id === p.id)?.quantity || 0;
            return `
              <div class="product-item relative bg-white p-3 rounded-2xl shadow-sm border-2 border-transparent active:border-orange-500 active:scale-95 transition-all flex flex-col justify-between min-h-[110px] cursor-pointer" data-id="${p.id}">
                <div>
                  <h3 class="font-bold text-blue-900 leading-tight">${p.name}</h3>
                  <p class="text-xs font-bold mt-1 ${p.stock <= 0 ? 'text-orange-500' : 'text-gray-400'}">Stock: ${p.stock}</p>
                </div>
                <div class="flex justify-between items-end mt-2">
                  <span class="text-xl font-black text-gray-800">$${formatCurrency(p.price)}</span>
                  ${admin ? `<button class="edit-btn p-2 bg-blue-50 text-blue-600 rounded-full" data-id="${p.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="14 2 18 6 7 17 3 17 3 13 14 2"/><line x1="3" y1="13" x2="7" y2="17"/></svg>
                  </button>` : n > 0 ? `<span class="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full">${n}</span>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    };

    const renderCorte = () => {
      const totalVentas = ventas.reduce((a, b) => a + b.totalRevenue, 0);
      const comision = ventas.reduce((a, b) => a + b.quantitySold, 0);
      return `
        <div class="space-y-4 max-w-lg mx-auto">
          <h2 class="text-2xl font-bold text-blue-900">Corte del D√≠a</h2>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500">
              <p class="text-xs font-bold text-gray-400">TOTAL</p>
              <p class="text-3xl font-black text-blue-900">$${formatCurrency(totalVentas)}</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500">
              <p class="text-xs font-bold text-gray-400">COMISI√ìN</p>
              <p class="text-3xl font-black text-green-600">$${formatCurrency(comision)}</p>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">Prod</th>
                  <th class="p-3 text-center">Cant</th>
                  <th class="p-3 text-right">$$</th>
                </tr>
              </thead>
              <tbody>
                ${ventas.map(s => `
                  <tr class="border-t">
                    <td class="p-3">${s.name}</td>
                    <td class="p-3 text-center">${s.quantitySold}</td>
                    <td class="p-3 text-right font-bold">$${formatCurrency(s.totalRevenue)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div class="flex gap-2">
            <button id="btn-download" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold shadow">Descargar</button>
            <button id="btn-close-day" class="flex-1 bg-red-100 text-red-600 py-3 rounded-xl font-bold">Cerrar Corte</button>
          </div>
        </div>
      `;
    };

    // ================== FUNCIONES ==================
    const checkout = async () => {
      const pVal = parseFloat(pago);
      const total = carrito.reduce((a, b) => a + (b.price * b.quantity), 0);
      if (!pVal || pVal < total || !user) return;

      const saleData = [...carrito];
      carrito = []; pago = '';
      render();
      notify(`Cobrado: $${formatCurrency(total)} | Cambio: $${formatCurrency(pVal - total)}`);

      try {
        const batch = writeBatch(db);
        for (const item of saleData) {
          const prodRef = doc(db, 'tiendas', STORE_ID, 'productos', item.id);
          batch.update(prodRef, { stock: (item.stock || 0) - item.quantity });
          batch.set(doc(collection(db, 'tiendas', STORE_ID, 'ventas')), {
            name: item.name,
            quantitySold: item.quantity,
            totalRevenue: item.price * item.quantity,
            date: new Date().toISOString()
          });
        }
        await batch.commit();
      } catch (err) {
        console.error("Error en venta:", err);
        notify("Venta no guardada. Reintentando...", "error");
      }
    };

    const closeDay = async () => {
      if (!confirm("¬øCERRAR CORTE? Se borrar√°n las ventas.")) return;
      notify("Cerrando corte...");
      try {
        const snap = await getDocs(collection(db, 'tiendas', STORE_ID, 'ventas'));
        const batch = writeBatch(db);
        snap.docs.forEach(d => batch.delete(d.ref));
        await batch.commit();
        notify("Corte cerrado exitosamente");
        render();
      } catch (err) {
        notify("Error al cerrar corte", "error");
      }
    };

    const download = () => {
      const d = new Date();
      const tot = ventas.reduce((a, b) => a + b.totalRevenue, 0);
      const com = ventas.reduce((a, b) => a + b.quantitySold, 0);
      let text = `CORTE ${d.toLocaleDateString()}\n----------------\nTOTAL: $${formatCurrency(tot)}\nCOMISI√ìN: $${formatCurrency(com)}\n----------------\n`;
      ventas.forEach(s => text += `${s.name} x${s.quantitySold} .. $${formatCurrency(s.totalRevenue)}\n`);
      const blob = new Blob(['\uFEFF' + text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Corte_${d.toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // ================== INICIALIZACI√ìN ==================
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (u) => {
      user = u;
      if (u) {
        onSnapshot(collection(db, 'tiendas', STORE_ID, 'productos'), (snap) => {
          productos = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name));
          render();
        });
        onSnapshot(collection(db, 'tiendas', STORE_ID, 'ventas'), (snap) => {
          ventas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          if (view === 'corte') render();
        });
      }
    });

    // Eventos globales
    document.addEventListener('click', e => {
      if (e.target.id === 'btn-new-product' || e.target.closest('#btn-new-product')) openProductModal();
      if (e.target.id === 'btn-download' || e.target.closest('#btn-download')) download();
      if (e.target.id === 'btn-close-day' || e.target.closest('#btn-close-day')) closeDay();
      if (e.target.id === 'btn-clear-search' || e.target.closest('#btn-clear-search')) { search = ''; render(); }
    });

    document.addEventListener('input', e => {
      if (e.target.id === 'search-input') {
        search = e.target.value;
        render();
      }
    });

    // Modal de producto (implementaci√≥n b√°sica)
    const openProductModal = (prod = null) => {
      const modal = document.createElement('div');
      modal.innerHTML = `
        <div class="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
          <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
          <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl z-10">
            <div class="flex justify-between mb-6">
              <h2 class="text-xl font-bold text-blue-900">${prod ? 'Editar' : 'Nuevo Producto'}</h2>
              <button class="p-2 bg-gray-100 rounded-full modal-close"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <form class="space-y-4" id="product-form">
              <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Nombre</label>
                <input name="n" value="${prod?.name || ''}" class="w-full text-xl p-3 bg-gray-50 border border-gray-200 rounded-xl font-medium outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" required/>
              </div>
              <div class="flex gap-4">
                <div class="flex-1">
                  <label class="text-xs font-bold text-gray-500 uppercase">Precio</label>
                  <input name="p" type="number" step="0.5" value="${prod?.price || ''}" class="w-full text-xl p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none focus:border-blue-500" required/>
                </div>
                <div class="flex-1">
                  <label class="text-xs font-bold text-gray-500 uppercase">Stock</label>
                  <input name="s" type="number" value="${prod?.stock || ''}" class="w-full text-xl p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-center outline-none focus:border-blue-500"/>
                </div>
              </div>
              <div class="flex gap-3 pt-4">
                ${prod ? '<button type="button" class="p-4 text-red-50 delete-product bg-red-50 rounded-xl"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>' : ''}
                <button type="submit" class="flex-1 bg-blue-600 text-white font-bold text-lg py-4 rounded-xl shadow-lg flex justify-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Guardar
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      modal.querySelector('.modal-close').onclick = () => modal.remove();
      modal.querySelector('#product-form').onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        const data = {
          id: prod?.id,
          name: form.n.value,
          price: parseFloat(form.p.value),
          stock: parseInt(form.s.value) || 0
        };
        try {
          if (data.id) {
            await updateDoc(doc(db, 'tiendas', STORE_ID, 'productos', data.id), data);
          } else {
            await addDoc(collection(db, 'tiendas', STORE_ID, 'productos'), data);
          }
          notify("Producto guardado");
          modal.remove();
        } catch (err) {
          notify("Error al guardar", "error");
        }
      };
      if (prod) {
        modal.querySelector('.delete-product').onclick = () => {
          if (confirm("¬øBorrar producto?")) {
            deleteDoc(doc(db, 'tiendas', STORE_ID, 'productos', prod.id));
            notify("Producto eliminado");
            modal.remove();
          }
        };
      }
    };

    // Mostrar loader inicial
    document.getElementById('app').innerHTML = `
      <div class="h-screen flex items-center justify-center bg-blue-900 text-white">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
      </div>
    `;
  </script>
</body>
</html>
