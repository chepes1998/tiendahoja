<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tienda de la Hoja ‚ö°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
      touch-action: manipulation;
      overflow: hidden;
    }
    .toast {
      animation: slideUp 2s forwards;
    }
    @keyframes slideUp {
      0% { transform: translateY(20px); opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { transform: translateY(0); opacity: 0; }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans h-screen overflow-hidden">
  <div id="app" class="h-full flex flex-col">
    <!-- Cargando... -->
    <div class="h-screen flex flex-col items-center justify-center bg-blue-900 text-white">
      <div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin mb-4"></div>
      <p>Iniciando Tienda de la Hoja...</p>
    </div>
  </div>

  <!-- Firebase desde CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <script>
    // ================== CONFIGURACI√ìN ==================
    const firebaseConfig = {
      apiKey: "AIzaSyBCg7bn-XbNce5fuB9JrYPXVsw50li1ySA",
      authDomain: "tienda-hoja.firebaseapp.com",
      projectId: "tienda-hoja",
      storageBucket: "tienda-hoja.firebasestorage.app",
      messagingSenderId: "750612062192",
      appId: "1:750612062192:web:26a25fcb5013a03d494735"
    };

    // ================== INICIALIZAR FIREBASE ==================
    let app, auth, db;
    let user = null;
    const STORE_ID = 'sucursal-principal';

    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      // Intentar persistencia offline (seguro)
      if (typeof db.enablePersistence === 'function') {
        db.enablePersistence().catch(() => {});
      }
    } catch (e) {
      console.error("Error al iniciar Firebase:", e);
      showError("Error al iniciar la app. Verifica tu conexi√≥n.");
      return;
    }

    // ================== UTILIDADES ==================
    function showError(msg) {
      document.getElementById('app').innerHTML = `
        <div class="h-screen flex flex-col items-center justify-center bg-red-50 p-4 text-center">
          <div class="text-red-600 text-5xl mb-4">‚ö†Ô∏è</div>
          <h2 class="text-xl font-bold text-gray-800 mb-2">Error</h2>
          <p class="text-gray-600 mb-6">${msg}</p>
          <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Reintentar</button>
        </div>
      `;
    }

    function notify(msg, type = 'success') {
      const div = document.createElement('div');
      div.className = 'toast fixed bottom-4 left-4 right-4 bg-gray-900 text-white p-3 rounded-lg z-50';
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 2000);
    }

    function format(n) {
      return n.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // ================== ESTADO ==================
    let view = 'pos'; // 'pos' o 'corte'
    let admin = false;
    let search = '';
    let productos = [];
    let ventas = [];
    let carrito = [];
    let pago = '';

    // ================== RENDER ==================
    function render() {
      const total = carrito.reduce((a, b) => a + (b.price * b.quantity), 0);
      const filtered = productos.filter(p =>
        p.name.toLowerCase().includes(search.toLowerCase())
      );

      const html = `
        <header class="bg-blue-900 text-white p-3 flex justify-between items-center">
          <div class="flex items-center gap-2">
            <div class="bg-orange-500 w-6 h-6 rounded-full flex items-center justify-center">
              <span class="text-xs">üçÅ</span>
            </div>
            <div>
              <h1 class="font-bold">Tienda de la Hoja</h1>
              <p class="text-xs opacity-80">Conectado</p>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="location.reload()" class="p-2 bg-blue-800 rounded">‚Üª</button>
            <button onclick="toggleAdmin()" class="px-2 py-1 text-xs font-bold ${admin ? 'bg-orange-500' : 'bg-blue-800'}">
              ${admin ? 'ADMIN' : 'VENTA'}
            </button>
            <button onclick="toggleView()" class="p-2 bg-blue-800 rounded">${view === 'pos' ? 'üìä' : '‚Üê'}</button>
          </div>
        </header>

        <main class="flex-1 overflow-y-auto p-3 pb-32">
          ${view === 'pos' ? renderPOS(filtered) : renderCorte()}
        </main>

        ${view === 'pos' ? `
          <div class="bg-white border-t p-3 shadow-lg">
            <div class="flex justify-between mb-2">
              <span class="font-medium">${carrito.length} √≠tems</span>
              <span class="font-bold text-blue-900">$${format(total)}</span>
            </div>
            <div class="flex gap-2">
              <input type="number" placeholder="Pago" value="${pago}" 
                oninput="pago = this.value; render();" 
                class="flex-1 p-2 border rounded text-lg text-center" />
              <button onclick="checkout()" 
                class="flex-1 bg-green-600 text-white font-bold rounded ${total === 0 || parseFloat(pago) < total ? 'opacity-50' : ''}"
                ${total === 0 || parseFloat(pago) < total ? 'disabled' : ''}>
                COBRAR
              </button>
            </div>
          </div>
        ` : ''}
      `;

      document.getElementById('app').innerHTML = html;
      attachEventListeners();
    }

    function renderPOS(productos) {
      return `
        <div class="mb-3">
          <input type="text" placeholder="Buscar..." value="${search}" 
            oninput="search = this.value; render();"
            class="w-full p-2 border rounded" />
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
          ${productos.map(p => {
            const enCarrito = carrito.find(x => x.id === p.id);
            return `
              <div class="bg-white p-3 rounded shadow ${admin ? '' : 'cursor-pointer'}" 
                onclick="${admin ? '' : `addToCart('${p.id}')`}"
                data-id="${p.id}">
                <h3 class="font-bold text-sm">${p.name}</h3>
                <p class="text-xs text-gray-500">Stock: ${p.stock || 0}</p>
                <div class="flex justify-between items-end mt-1">
                  <span class="font-bold text-blue-900">$${format(p.price)}</span>
                  ${enCarrito ? `<span class="bg-orange-500 text-white text-xs px-2 rounded">${enCarrito.quantity}</span>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderCorte() {
      const totalVentas = ventas.reduce((a, b) => a + b.totalRevenue, 0);
      const comision = ventas.reduce((a, b) => a + b.quantitySold, 0);
      return `
        <div class="max-w-md mx-auto">
          <h2 class="text-xl font-bold mb-4">Corte del D√≠a</h2>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-white p-3 rounded shadow">
              <p class="text-xs text-gray-500">TOTAL</p>
              <p class="font-bold text-blue-900 text-lg">$${format(totalVentas)}</p>
            </div>
            <div class="bg-white p-3 rounded shadow">
              <p class="text-xs text-gray-500">COMISI√ìN</p>
              <p class="font-bold text-green-600 text-lg">$${format(comision)}</p>
            </div>
          </div>
          <button onclick="downloadCorte()" class="w-full bg-green-600 text-white py-2 rounded mb-2">Descargar</button>
          <button onclick="closeDay()" class="w-full bg-red-600 text-white py-2 rounded">Cerrar Corte</button>
        </div>
      `;
    }

    function attachEventListeners() {
      // Ya no necesitamos listeners complejos porque usamos onclick directo
    }

    // ================== FUNCIONES ==================
    window.toggleAdmin = () => { admin = !admin; render(); };
    window.toggleView = () => { view = view === 'pos' ? 'corte' : 'pos'; render(); };

    window.addToCart = (id) => {
      const prod = productos.find(p => p.id === id);
      if (!prod) return;
      const exists = carrito.find(x => x.id === id);
      if (exists) exists.quantity++;
      else carrito.push({ ...prod, quantity: 1 });
      notify(`${prod.name} agregado`);
      render();
    };

    window.checkout = async () => {
      const pVal = parseFloat(pago);
      const total = carrito.reduce((a, b) => a + (b.price * b.quantity), 0);
      if (!pVal || pVal < total) return;

      const saleData = [...carrito];
      carrito = []; pago = '';
      render();
      notify(`Cobrado: $${format(total)} | Cambio: $${format(pVal - total)}`);

      try {
        const batch = db.batch();
        saleData.forEach(item => {
          const prodRef = db.collection('tiendas').doc(STORE_ID).collection('productos').doc(item.id);
          batch.update(prodRef, { stock: firebase.firestore.FieldValue.increment(-item.quantity) });
          const ventaRef = db.collection('tiendas').doc(STORE_ID).collection('ventas').doc();
          batch.set(ventaRef, {
            name: item.name,
            quantitySold: item.quantity,
            totalRevenue: item.price * item.quantity,
            date: new Date().toISOString()
          });
        });
        await batch.commit();
      } catch (err) {
        console.error("Error en venta:", err);
        notify("Venta no guardada. Reintentando...", "error");
      }
    };

    window.downloadCorte = () => {
      const d = new Date();
      let text = `CORTE ${d.toLocaleDateString()}\n`;
      text += `TOTAL: $${ventas.reduce((a, b) => a + b.totalRevenue, 0)}\n`;
      text += `VENTAS:\n`;
      ventas.forEach(v => text += `${v.name} x${v.quantitySold} = $${v.totalRevenue}\n`);
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `corte-${d.toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.closeDay = async () => {
      if (!confirm("¬øCerrar corte? Se borrar√°n las ventas.")) return;
      try {
        const ventasSnap = await db.collection('tiendas').doc(STORE_ID).collection('ventas').get();
        const batch = db.batch();
        ventasSnap.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        notify("Corte cerrado");
        render();
      } catch (err) {
        notify("Error al cerrar corte", "error");
      }
    };

    // ================== INICIALIZAR ==================
    auth.signInAnonymously().catch(err => {
      console.error("Error login:", err);
      showError("No se pudo iniciar sesi√≥n. Revisa tu conexi√≥n.");
    });

    auth.onAuthStateChanged(u => {
      if (!u) return;
      user = u;

      // Escuchar productos
      db.collection('tiendas').doc(STORE_ID).collection('productos')
        .onSnapshot(snap => {
          productos = [];
          snap.forEach(doc => productos.push({ id: doc.id, ...doc.data() }));
          productos.sort((a, b) => a.name.localeCompare(b.name));
          render();
        }, err => {
          console.error("Error productos:", err);
          showError("No se pudieron cargar los productos.");
        });

      // Escuchar ventas
      db.collection('tiendas').doc(STORE_ID).collection('ventas')
        .onSnapshot(snap => {
          ventas = [];
          snap.forEach(doc => ventas.push(doc.data()));
          if (view === 'corte') render();
        });
    });

    // Evitar que la app se quede en blanco
    setTimeout(() => {
      if (!user) {
        document.getElementById('app').innerHTML = `
          <div class="h-screen flex items-center justify-center bg-gray-100 p-4 text-center">
            <p class="text-gray-600">Conectando con Firebase...</p>
          </div>
        `;
      }
    }, 3000);
  </script>
</body>
</html>
