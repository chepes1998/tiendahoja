<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tienda V19 üõ†Ô∏è</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans h-screen overflow-hidden select-none">
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { Search, ShoppingCart, Trash2, Download, RefreshCw, Archive, Leaf, Settings, X, Plus, Edit2, Save, DollarSign, Loader, Wifi, AlertTriangle } from 'lucide-react';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, writeBatch, getDocs } from 'firebase/firestore';

    // =================================================================
    // üëá PEGA TUS LLAVES AQU√ç üëá
    // =================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBCg7bn-XbNce5fuB9JrYPXVsw50li1ySA",
      authDomain: "tienda-hoja.firebaseapp.com",
      projectId: "tienda-hoja",
      storageBucket: "tienda-hoja.firebasestorage.app",
      messagingSenderId: "750612062192",
      appId: "1:750612062192:web:26a25fcb5013a03d494735"
    };

    // Inicializaci√≥n
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const STORE_ID = 'sucursal-principal';

    // --- COMPONENTE DE DIAGN√ìSTICO ---
    const StatusBadge = ({ status, error }) => {
      if (error) return <div className="bg-red-600 text-white px-2 py-1 text-xs font-bold w-full text-center">ERROR: {error}</div>;
      return (
        <div className={`px-2 py-1 text-xs font-bold w-full text-center flex justify-center items-center gap-2 ${status === 'connected' ? 'bg-green-600 text-white' : 'bg-yellow-500 text-black'}`}>
          {status === 'connected' ? <Wifi size={12}/> : <Loader size={12} className="animate-spin"/>}
          {status === 'connected' ? 'CONECTADO A NUBE' : 'CONECTANDO...'}
        </div>
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [view, setView] = useState('pos');
      const [admin, setAdmin] = useState(false);
      const [search, setSearch] = useState('');
      const [prods, setProds] = useState([]);
      const [cart, setCart] = useState([]);
      const [pay, setPay] = useState('');
      const [status, setStatus] = useState('connecting');
      const [errorMsg, setErrorMsg] = useState('');
      
      // Modal
      const [modalOpen, setModalOpen] = useState(false);
      const [editP, setEditP] = useState(null);
      const [processing, setProcessing] = useState(false);

      // 1. Autenticaci√≥n
      useEffect(() => {
        signInAnonymously(auth).catch(e => setErrorMsg("Auth: " + e.message));
        return onAuthStateChanged(auth, u => {
          setUser(u);
          if (u) setStatus('connected');
        });
      }, []);

      // 2. Escuchar Productos (Lectura)
      useEffect(() => {
        if (!user) return;
        const unsub = onSnapshot(collection(db, 'tiendas', STORE_ID, 'productos'), 
          (snap) => {
            const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            setProds(data.sort((a,b) => a.name.localeCompare(b.name)));
          },
          (err) => {
            console.error(err);
            setErrorMsg("Error Lectura: " + err.message);
            if(err.message.includes("permission")) setErrorMsg("ERROR DE PERMISOS: Revisa las Reglas en Firebase");
          }
        );
        return () => unsub();
      }, [user]);

      // 3. Guardar Producto (Escritura)
      const saveProduct = async (e) => {
        e.preventDefault();
        setProcessing(true);
        const form = new FormData(e.target);
        const data = {
          name: form.get('n'),
          price: parseFloat(form.get('p')),
          stock: parseInt(form.get('s')) || 0
        };

        try {
          const colRef = collection(db, 'tiendas', STORE_ID, 'productos');
          if (editP) {
            await updateDoc(doc(colRef, editP.id), data);
          } else {
            await addDoc(colRef, data);
          }
          setModalOpen(false);
          alert("‚úÖ Guardado correctamente");
        } catch (err) {
          console.error(err);
          alert("‚ùå ERROR AL GUARDAR:\n" + err.message + "\n\nVerifica tus reglas en Firebase.");
        }
        setProcessing(false);
      };

      // 4. Carrito
      const addCart = (p) => setCart(prev => {
        const ex = prev.find(x => x.id === p.id);
        return ex ? prev.map(x => x.id === p.id ? {...x, q: x.q + 1} : x) : [...prev, {...p, q: 1}];
      });

      const total = cart.reduce((a,b) => a + (b.price * b.q), 0);
      const filtered = prods.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));

      return (
        <div className="flex flex-col h-full">
          <StatusBadge status={status} error={errorMsg} />
          
          <div className="bg-blue-900 p-3 text-white flex justify-between items-center shadow-md shrink-0">
            <h1 className="font-bold text-xl">Tienda Hoja üçÅ</h1>
            <button onClick={() => setAdmin(!admin)} className={`px-3 py-1 rounded text-xs font-bold ${admin ? 'bg-orange-500' : 'bg-blue-700'}`}>
              {admin ? 'MODO ADMIN' : 'MODO VENTA'}
            </button>
          </div>

          <div className="flex-1 overflow-y-auto p-3 relative">
            <div className="flex gap-2 mb-4">
              <input 
                value={search}
                onChange={e => setSearch(e.target.value)}
                placeholder="Buscar..." 
                className="flex-1 p-3 rounded-xl border border-gray-300 text-lg"
              />
              {admin && (
                <button onClick={() => { setEditP(null); setModalOpen(true); }} className="bg-blue-600 text-white p-3 rounded-xl shadow-lg">
                  <Plus size={24}/>
                </button>
              )}
            </div>

            <div className="grid grid-cols-2 gap-3">
              {filtered.map(p => (
                <div key={p.id} onClick={() => !admin && addCart(p)} className="bg-white p-3 rounded-xl shadow border-2 border-transparent active:border-orange-500 transition-all">
                  <div className="font-bold text-blue-900 truncate">{p.name}</div>
                  <div className="text-xs text-gray-500 mb-2">Stock: {p.stock}</div>
                  <div className="flex justify-between items-center">
                    <span className="text-xl font-black">${p.price}</span>
                    {admin && <button onClick={(e) => { e.stopPropagation(); setEditP(p); setModalOpen(true); }} className="p-1 bg-gray-100 rounded"><Edit2 size={16}/></button>}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* CARRITO SIMPLE */}
          {!admin && (
            <div className="bg-white border-t p-3 shadow-lg shrink-0">
              <div className="flex justify-between items-center mb-3">
                <span className="font-bold text-gray-600">{cart.length} arts.</span>
                <span className="text-2xl font-black text-blue-900">${total}</span>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setCart([])} className="bg-red-100 text-red-600 p-3 rounded-xl"><Trash2/></button>
                <button className="flex-1 bg-green-600 text-white font-bold rounded-xl shadow-lg">COBRAR</button>
              </div>
            </div>
          )}

          {/* MODAL PRODUCTO */}
          {modalOpen && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <h2 className="text-xl font-bold mb-4">{editP ? 'Editar' : 'Nuevo'} Producto</h2>
                <form onSubmit={saveProduct} className="space-y-4">
                  <div><label className="text-xs font-bold text-gray-500">Nombre</label><input name="n" defaultValue={editP?.name} className="w-full p-2 border rounded text-lg" required autoFocus/></div>
                  <div className="flex gap-2">
                    <div className="flex-1"><label className="text-xs font-bold text-gray-500">Precio</label><input name="p" type="number" step="0.5" defaultValue={editP?.price} className="w-full p-2 border rounded text-lg font-bold" required/></div>
                    <div className="flex-1"><label className="text-xs font-bold text-gray-500">Stock</label><input name="s" type="number" defaultValue={editP?.stock} className="w-full p-2 border rounded text-lg text-center"/></div>
                  </div>
                  <div className="flex gap-2 pt-2">
                    <button type="button" onClick={() => setModalOpen(false)} className="flex-1 p-3 bg-gray-100 rounded-xl font-bold">Cancelar</button>
                    <button type="submit" disabled={processing} className="flex-1 p-3 bg-blue-600 text-white rounded-xl font-bold flex justify-center">
                      {processing ? <Loader className="animate-spin"/> : 'Guardar'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
